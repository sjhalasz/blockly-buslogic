<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Blockly Demo: Business Logic</title>
  <script src="blockly_compressed.js"></script>
  <script src="blocks_compressed.js"></script>
  <script src="en.js"></script>
  <script src="blocks.js"></script>
  <style>
    body {
      background-color: #fff;
      font-family: sans-serif;
    }
    h1 {
      font-weight: normal;
      font-size: 140%;
    }
  </style>
</head>
<body>
  <h1>Blockly Demo of Business Logic</h1>

  <div id="blocklyDiv" style="height: 600px; width: 1200px;"></div>
  <textarea id="textarea" style="height: 600px; width: 1200px;"></textarea>

  <xml id="toolbox" style="display: none">
    <block type="settlement_days"></block>
    <block type="set_variable"></block>
    <block type="client"></block>
    <block type="conditional"></block>
    <block type="comparison"></block>
    <block type="conjunction"></block>
    <block type="variable"></block>
    <block type="value"></block>
  </xml>

  <script>
    var workspace = Blockly.inject('blocklyDiv', {toolbox: document.getElementById('toolbox')});
    function myUpdateFunction(event) {
      var dom = Blockly.Xml.workspaceToDom(workspace);
      document.getElementById('textarea').value = translateDom(dom);
    }
    workspace.addChangeListener(myUpdateFunction);  
    function translateDom(dom){
      if(dom.tagName != 'XML') throw 'expected XML tag';
      if(dom.childNodes.length != 1) throw 'expected exactly one "settlement days" block';
      var code = dom.childNodes[0]; // get code from <xml> wrapper
      if(code.tagName != "BLOCK") throw 'expected "BLOCK" tag on "settlement_days" block';
      if(getAttribute(code, 'type') !='settlement_days') throw 'expected block of type "settlement_days"';
      code = code.childNodes;
      if(code.length != 1) throw 'expected exactly one "days_calculation" statements input';
      code = code[0];
      if(code.tagName != 'STATEMENT') throw 'expected "STATEMENT" tag for "days_calculation"';
      if(getAttribute(code, 'name') != 'days_calculation') throw 'expected name to be "days_calculation"';
      var r = translateBlocks(code.childNodes);
      return '<settlement_days>' + r + '</settlement_days>';
    }
    function getAttribute(node, name){
      var attributes = node.attributes;
      for(var i = 0; i < attributes.length; i++){
        if(attributes[i].name == name) return attributes[i].value;
      }
    }
    function translateBlocks(nodes){
      var node0 = nodes[0];
      if(!node0.tagName == "BLOCK") throw 'expected BLOCK tag';
      var type = getAttribute(node0, 'type');
      switch(type){
        case 'set_variable':
          var n = node0.childNodes[0];
          if(n.tagName != "FIELD") throw 'expected FIELD tag in set_variable child';
          if(getAttribute(n, 'name') != 'variable_name') throw 'expected FIELD node named "variable_name"';
          var variable_name = n.innerText;
          r = '<set_variable>' + variableName + '</set_variable>';
          // if there's another child node in node0 it's a "NEXT" ...
      }      
    }
</script>

</body>
</html>
