<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Blockly Demo: Business Logic</title>
  <script src="blockly_compressed.js"></script>
  <script src="blocks_compressed.js"></script>
  <script src="en.js"></script>
  <script src="blocks.js"></script>
  <style>
    body {
      background-color: #fff;
      font-family: sans-serif;
    }
    h1 {
      font-weight: normal;
      font-size: 140%;
    }
  </style>
</head>
<body>
  <h1>Blockly Demo of Business Logic</h1>

  <div id="blocklyDiv" style="height: 600px; width: 1200px;"></div>
  <textarea id="textarea" style="height: 600px; width: 1200px;"></textarea>

  <xml id="toolbox" style="display: none">
    <block type="settlement_days"></block>
    <block type="set_variable"></block>
    <block type="client"></block>
    <block type="conditional"></block>
    <block type="comparison"></block>
    <block type="conjunction"></block>
    <block type="variable"></block>
    <block type="value"></block>
  </xml>

  <script>
    var workspace = Blockly.inject('blocklyDiv', {toolbox: document.getElementById('toolbox')});
    function myUpdateFunction(event) {
      var dom = Blockly.Xml.workspaceToDom(workspace);
      document.getElementById('textarea').value = translateDom(dom);
    }
    workspace.addChangeListener(myUpdateFunction);  
    function translateDom(dom){
      if(dom.tagName != 'XML') throw 'expected XML tag';
      if(dom.childNodes.length != 1) throw 'expected exactly one "settlement days" block';
      var code = dom.childNodes[0]; // get code from <xml> wrapper
      if(code.tagName != "BLOCK") throw 'expected "BLOCK" tag on "settlement_days" block';
      if(getAttribute(code, 'type') !='settlement_days') throw 'expected block of type "settlement_days"';
      code = code.childNodes;
      if(code.length != 1) throw 'expected exactly one "days_calculation" statements input';
      code = code[0];
      if(code.tagName != 'STATEMENT') throw 'expected "STATEMENT" tag for "days_calculation"';
      if(getAttribute(code, 'name') != 'days_calculation') throw 'expected name to be "days_calculation"';
      indent = 0;
      var r = translateBlocks(code.childNodes);
      return '<settlement_days>\n' + r + '</settlement_days>\n';
    }
    function getAttribute(node, name){
      var attributes = node.attributes;
      for(var i = 0; i < attributes.length; i++){
        if(attributes[i].name == name) return attributes[i].value;
      }
    }
    function translateBlocks(nodes){
      if(nodes.length != 1) throw 'expected exactly 1 child node in translateBlocks';
      var node0 = nodes[0];
      if(!node0.tagName == "BLOCK") throw 'expected BLOCK tag';
      var children = node0.childNodes;
      var n = children[0]; // guaranteed to be a node here
      var count = 1;
      if(n.tagName != "FIELD") throw 'expected FIELD node in BLOCK';
      var type = getAttribute(node0, 'type');
      indent++;
      switch(type){
        case 'set_variable':
          if(getAttribute(n, 'name') != 'variable_name') throw 'expected FIELD node named "variable_name"';
          var variableName = n.innerText;
          if(isInvalidVariableName(variableName)) throw "variable name can't have < > & %";
          r = indentIt() + '<set_variable name="' + variableName + '">\n';
          // may or may not be a "statement" node here with name "variable_value"
          if(children.length > count){
            n = children[count];
            if(n.tagName == "STATEMENT"){
              count++;
              if(getAttribute(n, 'name') != 'variable_value') throw 'expected STATEMENT with name "variable_value"';
              r += translateBlocks(n.children);
            }
          }
          r +=  indentIt() + '</set_variable>\n';
          break;
        case 'client':
          if(getAttribute(n, 'name') != 'client_code') throw 'expected FIELD node named "client_code"';
          var clientCode = n.innerText;
          r = indentIt() + '<client_code>' + clientCode + '</client_code>\n';
          break;
      }
      indent--;
      // if there's another child node in node0 it's a "NEXT" ...
      if(children.length > count){
        n = children[count];
        if(n.tagName != "NEXT") throw 'expected "NEXT" node in "set_variable"';
        r += translateBlocks(n.childNodes);
      }
      return r;
    }
    function isInvalidVariableName(name){
      return /[<>&%'"]/g.test(name);
    }
    function indentIt(){
      return Array((2 * indent) + 1).join(' ');
    }
</script>

</body>
</html>
